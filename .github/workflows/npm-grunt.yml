---
name: "NodeJS with Grunt"

on:
  push:
    branches: ["main", "hotfix"]
  pull_request:
    branches: ["main"]

# Prevent concurrent runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 8

    strategy:
      matrix:
        node-version: [24.x, 25.x]
      fail-fast: false

    steps:
    - uses: actions/checkout@v6

    - uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Security Audit
      run: npm audit --omit=dev --audit-level=moderate
      # TODO: re-evaluate continue-on-error on Dec 18, 2025 or after js-yaml update
      continue-on-error: true

    - name: Install Dependencies
      run: npm ci --prefer-offline

    - name: Build with Grunt (baseline)
      run: npx grunt

    - name: Backup Grunt output
      run: mkdir -p .build-comparison && cp -r web .build-comparison/web-grunt

    - name: Build with Terser (new)
      run: npm run build:terser

    - name: Compare build outputs
      run: |
        echo "Build Output Comparison: Terser vs Grunt/UglifyJS"
        echo "=================================================="
        echo ""
        printf "%-25s %10s %10s %10s %8s\n" "Bookmarklet" "Terser" "Grunt" "Diff" "% Diff"
        printf "%-25s %10s %10s %10s %8s\n" "-------------------------" "----------" "----------" "----------" "--------"

        total_terser=0
        total_grunt=0

        for file in web/*.js; do
          filename=$(basename "$file")
          terser_size=$(wc -c < "$file" | tr -d ' ')
          grunt_size=$(wc -c < ".build-comparison/web-grunt/$filename" | tr -d ' ')
          diff=$((terser_size - grunt_size))

          total_terser=$((total_terser + terser_size))
          total_grunt=$((total_grunt + grunt_size))

          if [ "$grunt_size" -gt 0 ]; then
            pct_diff=$(awk "BEGIN {printf \"%.1f\", ($diff / $grunt_size) * 100}")
          else
            pct_diff="0.0"
          fi

          printf "%-25s %10d %10d %10d %7s%%\n" "$filename" "$terser_size" "$grunt_size" "$diff" "$pct_diff"
        done

        echo ""
        total_diff=$((total_terser - total_grunt))
        pct_total=$(awk "BEGIN {printf \"%.2f\", ($total_diff / $total_grunt) * 100}")
        printf "%-25s %10d %10d %10d %7s%%\n" "TOTAL" "$total_terser" "$total_grunt" "$total_diff" "$pct_total"
        echo ""
        echo "Note: Terser maintains proper IIFE isolation (prevents global scope pollution)"
        echo "      Grunt/UglifyJS removes IIFE wrapper (toplevel:true causes variable leakage)"

    - name: Verify build artifacts
      run: |
        echo "Verifying all 16 bookmarklets were built..."
        file_count=$(ls -1 web/*.js | wc -l)
        if [ "$file_count" -eq 16 ]; then
          echo "✓ All 16 bookmarklets built successfully"
        else
          echo "✗ Expected 16 bookmarklets, found $file_count"
          exit 1
        fi

    - name: Generate SBOM
      run: npm sbom --sbom-format=cyclonedx --omit=dev > sbom.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v6
      with:
        name: sbom-node-${{ matrix.node-version }}
        path: sbom.json
        retention-days: 90

  build:
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 5
    steps:
      - name: Build Summary
        run: echo "All matrix builds completed successfully"
